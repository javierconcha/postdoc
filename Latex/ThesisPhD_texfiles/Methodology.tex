% !TEX root=Thesis_PhD.tex  
% the previous is to reference main .bib
%% CHAPTER
\chapter{Methodology and Approach}
\label{ch:method}

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
  \centering
% \resizebox{9cm}{!}{%
% Define block styles

% \tikzstyle{startstop} = [rectangle, rounded corners, minimum width=2em, minimum height=2em,text centered, draw=black, fill=white]
\tikzstyle{io} = [trapezium, trapezium left angle=70, trapezium right angle=110, minimum width=2em, minimum height=3em, text width=1.5cm, text centered, draw=black, fill=white]
\tikzstyle{process} = [rectangle, minimum width=3em, minimum height=2em, text width=2.2cm, text centered, draw=black, fill=white]
% \tikzstyle{decision} = [diamond, minimum width=2em, minimum height=2em, text centered, draw=black, fill=white]
\tikzstyle{arrow} = [thick,->,>=stealth]

\begin{tikzpicture}[node distance=3cm]

% \node (start) [startstop] {Start};

\node (L8image) [io] {Landsat \\Image};
\node (prepro) [process, right of=L8image] {Image \\pre-processing};
\node (AtmCorr) [process, right of=prepro] {Atmospheric Correction};
\node (RetProc) [process, right of=AtmCorr] {Retrieval Process};
\node (CPAmap) [io, right of=RetProc] {CPA \\maps};

\node (Val) [process, below of=CPAmap, yshift=1cm] {Validation};

% \node[align=left, below=0.0 of prepro] (List1) {\scriptsize - Cloud/Land/Water Mask\\\scriptsize - Radiometric Calibration};

\draw [arrow] (L8image) -- (prepro);
\draw [arrow] (prepro) -- (AtmCorr);
\draw [arrow] (AtmCorr) -- (RetProc);
\draw [arrow] (RetProc) -- (CPAmap);

\draw [arrow] (CPAmap) -- (Val);

\end{tikzpicture}

% } % resizebox end

\caption{High-level flowchart of the process. \label{fig:highlevelflowchart}}
\end{figure}

This chapter describes the methodology and approach taken to accomplish the specific objectives mentioned in \S\ref{ch:objectives}. As a review, these specific requirements are (\S\ref{sec:objectives}):
\begin{enumerate}
  \item To develop an over-water atmospheric correction algorithm for Landsat 8 reflective imagery.
  \item To design a water constituent concentration retrieval algorithm that can be applied to a specific study area.
  \item To validate results by comparing with {\it in situ} measurements and products from ocean color satellites.
\end{enumerate}

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
\vspace{1cm}
  \centering
% \resizebox{9cm}{!}{%
% Define block styles

% \tikzstyle{startstop} = [rectangle, rounded corners, minimum width=2.5em, minimum height=2em,text centered, draw=black, fill=white]

\tikzstyle{io} = [trapezium, trapezium left angle=70, trapezium right angle=110, minimum width=2em, minimum height=2em, text width=2cm, text centered, draw=black, fill=white]

\tikzstyle{iosmall} = [trapezium, trapezium left angle=70, trapezium right angle=110, minimum width=1em, minimum height=1em, text width=1.0cm, text centered, draw=black, fill=white]

\tikzstyle{process} = [rectangle, minimum width=3em, minimum height=2em, text width=2.5cm, text centered, draw=black, fill=white]

\tikzstyle{decision} = [diamond, minimum width=2em, minimum height=2em, text centered, draw=black, fill=white]

\tikzstyle{arrow} = [thick,->,>=stealth]
\tikzstyle{arrowdashed} = [thick,dashed,->,>=stealth]

\begin{tikzpicture}[node distance=2cm]


% \node (start) [startstop] {Start};

\node (L8image) [io] {Landsat \\Image (DN)};
\node (radcal) [process, below of=L8image] {Radiometric \\Calibration};
\node (resize) [process, below of=radcal] {Resize};
\node (mask) [process, below of=resize] {Land/Cloud/\\Cloud Shadow \\Mask};
\node (AtmCorr) [process, below of=mask] {Atmospheric \\Correction \\(MoB-ELM)};
\node (rrs) [io, below of=AtmCorr,yshift=-1.5cm] {$R_{rs}$ \\Image};
\node (RetProc) [process, below of=rrs] {Retrieval \\Process \\(RMSE/ \\lsqnonlin)};
\node (CPAmap) [io, below of=RetProc] {CPA \\maps};

\node (CDRImage) [io, left of=L8image, xshift=-1.5cm] {Landsat \\Reflectance \\Product};
\node (PIFmask) [process, below of=CDRImage] {PIF \\Mask};
\node (brightpx) [io, below of=PIFmask] {Bright\\Pixel};

\node (AOPs) [iosmall, right of=L8image, xshift=0.8cm] {{\it in situ} \\AOPs \\($R_{rs}$)};

\node (samples) [io, right of=AOPs, xshift=1.0cm] {Water \\Samples};
\node (labmea) [process, below of=samples] {Lab \\Mea.};
\node (IOPs) [iosmall, below of=labmea, xshift=-1cm] {IOPs};
\node (conc) [iosmall, below of=labmea, xshift=1cm] {Conc.};
\node (hydro) [process, below of=IOPs, xshift=1cm] {Hydrolight};
\node (darkpx) [iosmall, below of=hydro, xshift=-1.5cm] {Dark \\Pixel};
\node (LUT) [iosmall, below of=hydro, xshift=2.5cm] {LUT};

\node (bb_b) [iosmall, right of=hydro, xshift=1cm] {$b_b/b$};


\node (Comp) [process, right of=CPAmap, xshift=1.5cm] {Comparison};
\node (NRMSE) [io, below of=Comp] {NRMSE};

\node (Comprrs) [process, right of=rrs, xshift=0.8cm, yshift=1.5cm] {Comparison};
\node (NRMSE2) [io, right of=Comprrs, xshift=1.4cm] {NRMSE};

% \node[align=left, right=0.0 of prepro] (List1) {\scriptsize - Cloud/Land/Water Mask\\\scriptsize - Radiometric Calibration};

\draw [arrow] (L8image) -- (radcal);
\draw [arrow] (radcal) -- (resize);
\draw [arrow] (resize) -- (mask);
\draw [arrow] (mask) -- (AtmCorr);
\draw [arrow] (AtmCorr) -- (rrs);
\draw [arrow] (rrs) -- (RetProc);
\draw [arrow] (RetProc) -- (CPAmap);

\draw [arrowdashed] (L8image) -- (CDRImage);
\draw [arrow] (CDRImage) -- (PIFmask);
\draw [arrow] (PIFmask) -- (brightpx);
\draw [arrow] (brightpx) |- (AtmCorr);

\draw [arrow] (samples) -- (labmea);
\draw [arrow] (labmea) |- (IOPs);
\draw [arrow] (labmea) |- (conc);
\draw [arrow] (IOPs) -- (hydro);
\draw [arrow] (conc) -- (hydro);
\draw [arrow] (hydro) |- (darkpx);
\draw [arrow] (hydro) |- (LUT);
\draw [arrow] (darkpx) -- (AtmCorr);
\draw [arrow] (LUT) |- (RetProc);

\draw [arrowdashed] (AOPs) |- (hydro);
\draw [arrowdashed] (AOPs) -- (Comprrs);
\draw [arrowdashed] (rrs.east) -| (Comprrs.south);
\draw [arrowdashed] (Comprrs) -- (NRMSE2);

\draw [arrow] (conc.east) |- ([xshift=2.3cm]conc.east)  |- (Comp);
\draw [arrow] (CPAmap) -- (Comp);
\draw [arrow] (Comp) -- (NRMSE);

\draw [arrow] (hydro) -- (bb_b);

\draw [arrow] (bb_b.south) -- ([yshift=-0.8cm]bb_b.south) -| ([xshift=-0.5cm]hydro.south east);

% \draw [arrow] (hydro) |- (AtmCorr);
\end{tikzpicture}
% } % resizebox end
\caption{Detailed flowchart of the process. \label{fig:detailflowchart}}
\end{figure}


The processes described in this work were first introduced by \citet{Concha2013IGARSS} and are based on previous work done by \citet{Raqueno:2000}, \citet{Gerace:2012}, \citet{Pahlevan:2012b} and \citet{Gerace:2013}. A flowchart of the general processes involved is shown in \autoref{fig:highlevelflowchart}. The inputs are the Landsat 8 images and the final products are the maps of CPAs. The complete process can be divided into four different steps: image pre-processing, atmospheric correction, retrieval process, and validation. This chapter will be divided into these four processes. A more detailed flowchart is illustrated in \autoref{fig:detailflowchart} and a more pictorial diagram is shown in \autoref{fig:retrieval}.

In short, the whole process works as follows. First, the \gls{dn} image from the satellite is radiometrically calibrated, resized to include only the area of study, and masked for cloud and land. Then, the radiance image is atmospherically corrected and transformed to $R_{rs}$ spectra, as shown in \autoref{fig:detailflowchart}. At this point the $R_{rs}$ spectra of water pixels in the scene with unknown CPAs concentrations are compared with a LUT of $R_{rs}$ spectra with known CPAs concentrations. This comparison is made by using a spectrum-matching technique \citep{Raqueno:2000,Mobley:2005} that uses the \gls{rmse} and a non-linear optimization algorithm to find the closest match in the LUT. The end products are maps of CPA concentrations (see \autoref{fig:retrieval}). Finally, the CPA maps are validated by comparison with {\it in situ} data and standard bio-optical products. Each step in this retrieval process is described in more detail below.

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[htb]
  \centering
    \includegraphics[height=10cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/UltimateProcess.pdf}
    \caption{Retrieval process flow diagram. The radiance image from the satellite is first corrected for atmospheric effects, having as result $R_{rs}$ spectra for each water pixel in the image. Then, a spectrum-matching methodology is used to find the closest match in the least-squared sense for the water pixels with unknown CPAs concentration in the LUT of water pixels with known CPAs concentration. The final result is a concentration map for each CPA.  \label{fig:retrieval} }
\end{figure}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
\section{Image Pre-processing} 
\label{sec:prepro}

The images are downloaded for free from the server \url{http://earthexplorer.usgs.gov/} by \gls{usgs}. EarthExplorer contains data sets from several instruments, including the Landsat satellites (labeled as Landsat Archive). The user needs to create an account in order to download the Level 1 GeoTIFF Data Product (data in \gls{dn}). This data product includes the OLI's nine bands, plus a \gls{qa} band, the TIRS's two bands, and the metadata file (\_MTL). The images are downloaded based on search criteria such as location and time. These images are first ordered on demand for processing. Once the processing is ready, they can be downloaded from the site.

Once the images are downloaded, the next step is to perform a radiometric calibration to convert from \gls{dn} to \gls{toa} radiance. The radiometric calibration can be done in imaging processing tools, such an ENVI, which support Landsat 8 images. One of formulas to convert \gls{dn} to \gls{toa} radiance $L_{\lambda}$ using gain and bias values is
\begin{equation}
  L_{\lambda} = gain_{\lambda}*DN+bias_{\lambda}
\end{equation}
\noindent where $gain_{\lambda}$ and $bias_{\lambda}$ are provided in the MTL file. The image is then resized using the resize tool in the ENVI package in order to include only the area of study and make the process less time consuming.

Then, the following step is to correct the glint in the image, if present. Details of one glint removal method are described in \S\ref{subsec:glintremoval} below.

Finally, only the valid water pixels need to be used in the retrieval process. To do so, the land, cloud and cloud shadow need to be masked. Also, if bottom signal is present in the image, it needs to be masked, or not considered in the retrieval, since the bottom signal was not treated in this study. The water mask is created by thresholding the Landsat 8's SWIR 2 band, since the water pixels will have small values compared with the rest of the pixels, including land. The cloud and cloud shadow mask are obtained from the Landsat 8 Surface Reflectance Product's \citep{L8SurfProduct2015} cloud mask described in \S\ref{subsec:provisionalCDR}. Once all the masks have been created, they are combined using an $.AND.$ logic operation.

% @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
\section{Over-Water Atmospheric Correction} 
\label{sec:atmcorr}
The first objective in this research is to identify a suitable approach to atmospherically correct the type of dataset provided by the OLI sensor. This is a complex task to perform over water because the signal leaving the water that reaches the sensor is very small compared to the signal reaching the sensor from atmospheric scattering. In ocean color, the end goal of the atmospheric correction is to convert from radiance units to the variable of interest for ocean color: \acrfull{rhow} or \acrfull{rrs}.

Most of the atmospheric correction algorithms used for the heritage Ocean Color instruments (e.g. CZCS, MODIS and SeaWiFS) are based on the work done by \citet{Gordon:1994} (also described in \citet{Gordon:1997}). The NASA's standard algorithms for atmospheric correction based on \citet{Gordon:1994} have proved to work well in Case 1 waters where there are at least two wavelengths with a water-leaving signal negligible or known. Therefore, these algorithms could be considered a global solution for Case 1 waters, i.e. they could be applied in most cases. The wavelengths used for clear waters (Case 1) are in general in the near infrared (NIR) part of the spectrum. For highly turbid water (Case 2) or highly productive Case 1 waters, a combination of wavelengths in the NIR and shortwave infrared (SWIR), or two SWIR wavelengths can be used \citep{Wang:2007,Wang:2007dz,Wang2009}. Some efforts have been made to demonstrate the feasibility of using Landsat 8 for ocean color measurements in coastal waters that apply the Gordon and Wang approach for the atmospheric correction using the Landsat 8's NIR and SWIR 1 bands, or the SWIR 1 and SWIR 2 bands \citep{Vanhellemont2014a,Vanhellemont2014,Vanhellemont:2015,Franz:2015}. One problem with using the Gordon and Wang approach on Landsat 8 imagery is that it requires a sufficient \gls{snr} over water in order to discriminate the water-leaving signal from the instrument noise. This could be particular important for OLI since it has noisy SWIR bands (relative to ocean color instruments), and so derived ocean color products that use these bands for the aerosol determination can be noisy \citep{Vanhellemont2014a}.

However, some of the atmospheric correction algorithms applied to the heritage Ocean Color instruments are not suitable for highly turbid coastal waters because the {\it black pixel assumption} cannot be applied to these types of waters \citep{Patt2003}. \citet{Concha2014SPIE} developed the \gls{mobelm} as an alternative for the standard atmospheric correction algorithms that does not rely on a negligible water-leaving signal assumption, and therefore it is not as sensitive to the SNR. The MoB-ELM algorithm uses a bright and dark pixel from the image to perform the atmospheric correction. % One of the goals of this work is to compare the MoB-ELM with the standard algorithms as well as with {\it in situ} data. These comparisons are made in remote-sensing reflectance $R_{rs}$ units. 

Two approaches for atmospheric compensation are investigated in this research: the \citet{Gordon:1994} approach, and the \citet{Concha2014SPIE} approach.

Some atmospheric correction methods described in this section will use the notation used by \citet{Gordon:1994} and \citet{Ruddick:2000bs} who define the \gls{rho} as 

\begin{equation}\label{eq:rho}
  \rho = \frac{\pi L}{F_o \cos{\theta}}
\end{equation}
where $L$ is upward radiance in the given viewing direction, $F_o$ is exoatmospheric irradiance, and $\theta$ is the solar-zenith angle. \autoref{eq:rho} allows a direct transformation from radiance to reflectance and vice versa. Therefore, taking into account all its contributors, the governing equation for \gls{rhot} can be expressed as

\begin{equation}\label{eq:rho_t}
  \rho_t(\lambda) = \rho_r(\lambda) + \rho_a(\lambda) + \rho_{ra}(\lambda) + T_v[\rho_w(\lambda) + \rho_{wc}(\lambda)]
\end{equation}
where:\\
\indent $\rho_t(\lambda)$ is the reflectance at the top of the atmosphere \\
\indent $\rho_r(\lambda)$ is the reflectance due to multiple scatter by air molecules only (Rayleigh scattering)\\
\indent $\rho_a(\lambda)$ is the reflectance due to multiple scatter by aerosols only\\
\indent $\rho_{ra}(\lambda)$ is the reflectance due to the interaction between Rayleigh and aerosol scattering\\
\indent $T_v(\lambda)$ is the diffuse atmospheric transmittance from the water to the sensor\\
\indent $\rho_{wc}(\lambda)$ is the reflectance due to solar photons reflecting off the air-water interface (from whitecaps and glint or glitter)\\
\indent $\rho_w(\lambda)$ is the water-leaving reflectance

The \acrfull{rhow}\index{marine reflectance $\rho_w$} (a.k.a. marine reflectance) is related to the \acrfull{rrs} as
\begin{equation}\label{eq:Rrs_And_rhow}
 R_{rs} = \frac{\rho_w}{\pi}~~~\left[\frac{1}{sr}\right]
\end{equation}

In order to perform the water constituent retrieval, we need to solve for only the $\rho_w(\lambda)$ term in \autoref{eq:rho_t}, which would be an easy task if all the rest of the terms were known. Unfortunately, the only term known {\it a priori} is the $\rho_t(\lambda)$, which is precisely the image of the scene itself. The main difference among the methods based on \citet{Gordon:1994} is in the approach used to estimate $\rho_a(\lambda) + \rho_{ra}(\lambda)$ in the visible (VIS) using an estimation of $\rho_a(\lambda) + \rho_{ra}(\lambda)$ in the near infrared (NIR).

This section describes the different alternatives to obtain the rest of the terms in \autoref{eq:rho_t}.

% ---------------------------------------------------------------------------
\subsection{Solar-Glint Removal Algorithm}
\label{subsec:glintremoval}
The first step to solve \autoref{eq:rho_t} is to find the term due to glint, $\rho_{wc}(\lambda)$ and remove it from the total signal. This term $\rho_{wc}(\lambda)$ can be ignored in some cases since ocean-color sensors are designed to be tilted to avoid the specular image of the sun. However, Landsat 8 is not cataloged as an ocean-color satellite and it may need to be corrected for the glint effect depending on the location of the water in the scene, the sun location, and the wind conditions. Sometimes, the influence of glint can be strong, making it difficult to process the images, as can be seen in the Landsat 8 image over the study area acquired on 07-11-2014 (LC80170302014192LGN00), shown in \autoref{fig:L8glint}, with a sun elevation equal to $62^\circ$. Note the structure underneath the glint.
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[htb]
  \centering
    \includegraphics[height=10cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/L8Glint}
    \caption{Landsat 8 image acquired on 07-11-2014 (LC80170302014192LGN00) with a strong glint over the study area.  \label{fig:L8glint} }
\end{figure}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

An example of a glint removal algorithm is the method suggested by \citet{Hedley:2005}, which is a revised version of the method suggested by \citet{Hochberg:2003}. The method described by Hochberg was developed for high spatial resolutions where glint effects occur at physical scales comparable to image pixels ($<10m$) as opposed to methods developed for ocean-color sensor, which tend to have large physical scales ($>1km$).
The method presented by \citet{Hochberg:2003} is sensitive to outlier pixels and it needs to mask the land and cloud areas before deglinting. The method suggested by \citet{Hedley:2005} overcomes these inconveniences. This method assumes that (a) the brightness in the NIR is composed only of sun glint and a spatially constant ambient NIR component associated with NIR backscatter in the atmosphere (if the image is not atmospherically corrected), and (b) that the amount of sun glint in the visible bands is linearly related to the brightness (glint) in the NIR band. 

The first assumption is true for waters that are not highly turbid since water is relatively opaque to NIR wavelength ($700-1000nm$). The second assumption of a linear relationship between NIR brightness and the amount of sun glint in the visible bands relies on the fact that the real index of refraction, which is associated with the reflection in the water surface, is nearly equal for NIR and visible wavelengths \citep{Mobley1994}. As a result, the amount of light reflected in the visible bands is proportional to the amount of light reflected in the NIR, and therefore, a linear relationship can be established among them. The first step is to establish this relationship. This is accomplished by solving a linear regression between NIR and visible bands using one or more ROIs (\gls{roi}) from the water pixels in the image where some sun glint is noticeable, and their pixels values would be of similar values otherwise. An example of a ROI could be a ROI over deep water in the lake. A slope is determined from solving this linear regression with NIR pixel values in the ROI as the independent variable ($x$-axis) and a particular visible band as the dependent variable ($y$-axis), as shown in \autoref{fig:regressiohedley}. If the regression slope for band $i$ is $b_i$, then sun-glint corrected pixel brightness in band $i$ can be obtained by applying the following formula
\begin{equation}\label{eq:deglint}
  R_i' = R_i - b_i(R_{NIR}-min_{NIR})
\end{equation}
where $R_i'$ is the sun-glint corrected pixel value in band $i$, $R_i$ is the pixel value in the visible band $i$, $R_{NIR}$ is the NIR pixel value, and $min_{NIR}$ is the ambient NIR level and it represents the NIR brightness of a pixel with no sun glint. $min_{NIR}$ can be the minimum NIR value in the ROI used in the linear regression or as the minimum NIR in the water pixels. This method has the advantage that it operates purely on the relative magnitudes of values, and therefore the absolutes magnitudes are not important. The author suggests use of ROIs from different regions in the image, including ROIs where there is not glint at all. An example of an image before and after applying this method is shown in \autoref{fig:HedlyGlint}.
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[htb]
  \centering
  \includegraphics[width=11cm,clip=true]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/RegressionHedley.png}
  \caption{Linear regression used in the deglinting process (Note: image taken from \citet{Hedley:2005}). \label{fig:regressiohedley} } 
\end{figure}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[htb]
  \centering
    \includegraphics[height=8cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/HedleyGlint}
    \caption{Example of the glint removal algorithm (a) before and (b) after correction (image taken from \citet{Hedley:2005}).  \label{fig:HedlyGlint} }
\end{figure}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The different steps are summarized as follows:\\
\noindent{\bf Solar-Deglinting Algorithm Summary}\\
{\bf Step 1:} Select a ROI in the image where there is a range of sun glint, but where the brightness values would be uniform otherwise.\\
{\bf Step 2:} Determine $min_{NIR}$ by selecting the minimum NIR value of ROI.\\
{\bf Step 3:} Determine the slope $b_i$ from a linear regression between the NIR values ($x$-axis) and the visible band $i$ to be deglinted ($y$-axis).\\
{\bf Step 4:} Deglint all pixels in the image using \autoref{eq:deglint}.\\
{\bf Step 5:} Repeat step 1-4 for each band to be deglinted.

Some considerations need to be taken into account in order to apply this method. The first assumption is only valid when there is no water with high concentration of sediment present in the image, so precautions have to be taken to avoid highly turbid water in the image. As a way to overcome this problem, the OLI's SWIR 1 band (band 6) could be used instead of the NIR band since the water-leaving signal is negligible at $1600nm$, as suggested by \citet{GeraceThesis}. The real part of the index of refraction is still nearly equal for all wavelengths in the VNIR/SWIR, and therefore the second assumption of a linear relationship between NIR values and the amount of sun glint in the visible band is still valid. Another consideration is that if the ROIs selected include non-submerged objects (i.e. buoys, boats, land), this algorithm could output negative values. Therefore, it is recommended to mask all non-submerged objects before applying this method. 

The purpose of the deglinting process is to find the term $T_v\rho_{wc}$ in \autoref{eq:rho_t} and subtract it from the total TOA reflectance $\rho_t$,

\begin{equation}\label{eq:rhodeglint}
  \rho_t(\lambda)-T_v(\lambda)\rho_{wc}(\lambda) = \rho_r(\lambda)+\rho_a(\lambda)+\rho_{ra}(\lambda)+T_v(\lambda)\rho_{w}(\lambda)
\end{equation}

Once the water pixels in the image are deglinted, the next step is to atmospherically correct the image in order to isolate $\rho_w$ from \autoref{eq:rhodeglint}. There was not visual evidence of glint in the scenes used in this work, and therefore, they were not corrected for glint.


% ------------------------------------------------------------------
\subsection{Model-Based Empirical Line Method (MoB-ELM) Atmospheric Correction Method}
\label{subsec:mobelm}

The first atmospheric correction method will be the \gls{mobelm}\index{atmospheric correction!MoB-ELM} algorithm based on previous work done by \citet{Gerace:2013} and \citet{Gerace:2012}  for simulated OLI data and adapted by \citet{Concha2014SPIE} for actual OLI data. While this new method is based on the traditional ELM method (see \S\ref{sec:ELM}), this MoB-ELM method tries to avoid the measurement of ground truth at every sensor overpass over the scene by using \glspl{pif} in the scene as one target along with an estimation of water reflectivity for an open lake region for the other target. In the MoB-ELM atmospheric correction method, the dark pixel is obtained from a run of the radiative transfer model Hydrolight \citep{MobleyHEtech} simulating a water pixel in the scene with known CPAs concentrations and inherent optical properties (IOPs). The bright pixel is obtained from the Provisional Landsat 8 Surface Reflectance product \citep{L8SurfProduct2015} from USGS over a bright object in the scene or an average of bright pixels in the scene. The two targets used in this MoB-ELM to solve the regression in \autoref{eq:ELM} are referred to in this documents as the {\it bright pixel} \index{bright pixel} and the {\it dark pixel}\index{dark pixel}.

\subsubsection{Pseudo-Invariant Feature Extraction}

This method employs a \gls{pif}\index{pseudo-invariant features (PIF)} pixel extraction to mask urban landscape from both the reflectance product and the Landsat 8 image for the bright pixel determination. Pseudo-invariant targets are defined as targets whose reflectivity properties do not change rapidly between different times of collection  \citep{Schott:1988}. Examples of pseudo-invariant target are urban features in the scene.  The PIF extraction isolates the pseudoinvariant features from the digital imagery. In our case, the PIF are the man-made urban features in a scene. A flowchart of the process is shown in \autoref{fig:PIFflowchart}. 

\begin{figure}[htb]
	\centering
  \begin{tikzpicture}[node distance=0.75cm, auto]
          \tikzset{
                  basenode/.style={rectangle,rounded corners,draw=black,very thick, inner sep=1em, minimum size=3em, text centered,text width=2cm},
                  productnode/.style={ellipse,rounded corners,draw=black, very thick, text centered,text width=1.5cm},
                  myarrow/.style={->,>=stealth',thick, double = black},
                  mylabel/.style={text width=7em, text centered}
          }
          % SWIR branch
          \node[basenode] (SWIR) {SWIR 2\\ Band};
          \node[basenode, below=of SWIR] (TS1) {Mask by Threshold (upward)};
          \node[align=left, right=0.0 of TS1] (C1) {Urban\\Veget.\\Water};
          \node[align=left, right=-0.15 of C1] (C2) {ON\\ON\\OFF};

          % Ratio branch
          \node[basenode, right=2.5cm of SWIR] (Ratio) {Ratio\\ NIR Band/ Red Band};
          \node[basenode, below=of Ratio] (TS2) {Mask by Threshold (downward)};
          \node[align=left, right=0.0 of TS2] (C3) {Urban\\Veget.\\Water};
          \node[align=left, right=-0.15 of C3] (C4) {ON\\OFF\\ON};

          % AND
          \path (TS1.south)--(TS2.south) node[pos=.5,below=2cm] (AND) {.AND.};


          % PIF Mask
          \node[basenode, below=of AND] (PIFMask){PIF Mask};
          \node[align=left, left=0.85 of PIFMask] (C5) {Urban\\Veget.\\Water};
          \node[align=left, right=-0.15 of C5] (C6) {ON\\OFF\\OFF};

          \node[basenode, below=of TS2,right=2.0cm of AND] (Image) {Image};
          \path (Image.south)--(PIFMask.east) node[below=of Image,right=2cm of PIFMask] (AND2) {.AND.};
          \node[basenode, right=2cm of AND2] (PIFIm){PIF Image};

          \draw[myarrow] (SWIR)--(TS1);
          \draw[myarrow] (Ratio)--(TS2);
          \draw[myarrow] (TS1)--(AND);
          \draw[myarrow] (TS2)--(AND);
          \draw[myarrow] (AND)--(PIFMask);
          \draw[myarrow] (Image)--(AND2);
          \draw[myarrow] (PIFMask)--(AND2);
          \draw[myarrow] (AND2)--(PIFIm);
  \end{tikzpicture}
\caption{Illustration of the logic used to segment PIF features in a satellite image. \label{fig:PIFflowchart}}
\end{figure}

The PIF extraction from digital imagery proceeds in the following fashion (\autoref{fig:PIFflowchart}). An infrared-to-red ratio image is very effective in the classification of water, vegetation, and urban features. The vegetation in this ratio image will tend to have a high brightness when compared to the urban features and water brightness. This infrared-to-red ratio image can be derived from the quotient of the NIR band (band 4 for Landsat-5; band 5 for Landsat 8) and the red band (band 3 for Landsat-5; band 4 for Landsat 8), as seen in \autoref{fig:PIFflowchart}. This ratio image is thresholded from the high digital count values downward to create a mask so the high brightness pixels are eliminated (vegetation pixels) from the image, that is, these pixels are set to a value of zero and the rest (water and urban pixels) to a value of one. The SWIR 2 band (band 7 in Landsat-5 and Landsat 8) is used to eliminate the water pixels from the previous mask since water has nearly zero reflectance in this spectral region. This SWIR 2 band is thresholded from the low brightness values upward. Water pixels will exhibit a low value when compare to the rest of the pixels. A mask is created by assigning a value of zero to the low brightness pixels (water pixels) and a value of one to the rest (urban features and vegetation). Finally, the two masks created are combined using a logical .AND., resulting in a mask that will have a value of one only in the urban feature pixels, i.e. the PIFs, as shown in \autoref{fig:PIFflowchart}. This mask will be named ``PIF mask'' for the rest of this document. An example of a PIF mask is illustrated in \autoref{fig:PIFmask}. A false color image of Downtown Rochester, NY is shown on the left (vegetation in red) and a RGB image of the same area with the PIF mask applied is shown on the right (urban features in bright color while masked pixels in black).

% \vspace{-.3cm}
\begin{figure}[htb]
  \begin{minipage}[c]{0.48\linewidth}
    \centering
      \includegraphics[trim=30 0 30 0,clip,height=6cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/DTROCL8falsecolor.jpg}  
    % \vspace{1.5cm}
    \centerline{(a)}\medskip
  \end{minipage}
  \hfill
  \begin{minipage}[d]{0.48\linewidth}
    \centering
      \includegraphics[trim=30 0 30 0,clip,height=6cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/PIFmaskApplied.jpg}
    % \vspace{1.5cm}
    \centerline{(b)}\medskip
  \end{minipage}
  \caption{PIF mask determination. (a) False color image, with vegetation in red and (b) PIF mask over downtown Rochester with PIF features in gray. \label{fig:PIFmask} } 
\end{figure}

\subsubsection{Bright Pixel Determination}
The PIF mask is used to determine the bright pixel spectra in both radiance (from the Landsat 8 image) and reflectance values (from the Landsat Surface Reflectance CDR image \citep{LandsatCDR,L8SurfProduct2015}). See \S\ref{sec:CDR} for more details about the Landsat surface reflectance products. At the moment of starting this research, the Landsat reflectance product was available for a total of 9 Landsat 5 scenes where clear sky conditions were acceptable. Reflectance products for Landsat 8 were not available yet. One PIF mask for each of these 9 Landsat reflectance product scenes was created using ENVI. In addition, one PIF mask was created from the Landsat 8 radiance image. Finally, these 10 PIF masks were combined using a logical .AND. to create a ``master'' PIF mask \index{master PIF mask} in order to only include the PIF pixels coincident in all images. This is necessary because there is a non perfect geometry registration among all images. Then, the statistics were calculated in ENVI for each scene using this master PIF mask. An example of the statistical results obtained from ENVI are shown in \autoref{fig:PIFstats}.(a) and \autoref{fig:PIFstats}.(b) for one scene of the Landsat reflectance product (in reflectance units) and for the Landsat 8 image (in radiance units), respectively. The mean value is shown in black solid line, the green solid lines are the mean plus standard deviation and the mean minus standard deviation, and the red solid lines are the maximum and minimum values for each band. The mean values for each one of the 9 scenes are shown in \autoref{fig:ZenithCorr}. 

\begin{figure}[!ht]
  \begin{minipage}[c]{0.48\linewidth}
    \centering
      \includegraphics[height=9cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/PIFstatCDR.png}  
    % \vspace{1.5cm}
    \centerline{(a)}\medskip
  \end{minipage}
  \hfill
  \begin{minipage}[d]{0.48\linewidth}
    \centering
      \includegraphics[height=9cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/PIFstatL8.png}
    % \vspace{1.5cm} 
    \centerline{(b)}\medskip
  \end{minipage}
  \caption{Bright pixel determination using the PIF mask in ENVI. Statistics with the PIF mask applied for (a) Landsat reflectance product (in reflectance units) and (b) statistics for Landsat 8 image (in radiances units). \label{fig:PIFstats} } 
\end{figure}

\subsubsection{Solar Zenith Correction}

As seen in \autoref{fig:ZenithCorr}, the PIF reflectance values for each scene are not the same, but a high correlation between the reflectance values and the solar zenith angle for each band was found. A linear relationship was determined for each band by applying a linear regression in MATLAB and the $R^2$ and root mean square error (RMSE) values were calculated as a way to measure this correlation. This linear relationship has the form 
\begin{equation}
	y = m*x + y_0
	\label{eq:linear}
\end{equation}
where $x$ represents the solar zenith angle and $m$ the reflectance value. \autoref{fig:Band1Corr} shows the reflectance values versus the solar zenith angle for band 1 for the 9 Landsat 5 reflectance scenes and the calculated linear relationship. The values $m$ and $y_0$ found for all the bands are shown in \autoref{tab:ZenithCorr} along with the $R^2$ and RMSE values for each band. Note that the RMSE values in the visible are small. It can been seen in \autoref{tab:ZenithCorr} that the $R^2$ values are bigger than $0.9$ for all bands, which suggests there is a high correlation between the reflectance values and the solar zenith angle. As a conclusion, these results show that the reflectance values remain constant over time and the apparent reflectance (i.e. including shadow effects) depends on the solar zenith angle of the sensor. This is an expected behavior since intuitively the zenith angle influences the length of shadows in the scene, and the amount of shadow in the scene affects the brightness of the pixels, therefore the reflectance values. This is illustrated in \autoref{fig:shadow}, where two different solar zenith angles ($\theta_1$ and $\theta_2$) are shown, with $\theta_1<\theta_2$. A smaller zenith angle ($\theta_1$ in \autoref{fig:shadow}) means that the sun is positioned almost straight overhead, therefore there are smaller shadows from buildings in the scene. On the other hand, if the sun is closer to the horizon ($\theta_2$ in \autoref{fig:shadow}), i.e. larger zenith angle, the shadows produced by buildings will be bigger. From \autoref{fig:shadow}, one can intuitively conclude at least that the length of shadow is proportional to the zenith angle $\theta$, and consequently inversely proportional to $\cos{\theta}$.

\begin{figure}[!ht]
    \centering
    \includegraphics[height=13cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/Shadow_g.png}
  \caption{Shadow size as function of zenith angle. The shadow size are impacted by the zenith angle. \label{fig:shadow} } 
\end{figure}

The Landsat 8 image has associated a particular solar zenith angle. The previous linear relationships calculated will help to estimate the values for the reflectance value of the bright pixel for that particular solar zenith angle. For example, the solar zenith angle for the 09-19-13 Landsat 8 scene is equal to $45^\circ$, and therefore $x=45^\circ$ in \autoref{eq:linear}. The reflectance values for $x=45^\circ$ are shown in the last column of \autoref{tab:ZenithCorr} and plotted in \autoref{fig:ZenithCorr} as red asterisks.
%--------------------------------------
% \vspace{.5cm}
\begin{table}[htb]
\caption{ Zenith angle correction parameters. \label{tab:ZenithCorr} } 
\centering
\begin{tabular}{c|c|c|c|c|c} 
 \bfseries{Band n} & \bfseries{$m$}      & \bfseries{$y_0$}    & \bfseries{$R^2$}     & \bfseries{$RMSE$} & $y(x=45^\circ)$   \\ \hline \hline
 Band 1 & -0.000412 & 0.122631 & 0.937155 & 0.001705 &  0.1041\\
 Band 2 & -0.000634 & 0.147424 & 0.934344 & 0.002685 &  0.1189\\
 Band 3 & -0.000756 & 0.161421 & 0.976599 & 0.001869 &  0.1274\\
 Band 4 & -0.001316 & 0.220031 & 0.906946 & 0.006733 &  0.1608\\
 Band 5 & -0.001148 & 0.217231 & 0.903702 & 0.005984 &  0.1656\\
 Band 6 & -0.001159 & 0.206725 & 0.929626 & 0.005096 &  0.1546\\  
 \end{tabular}
\end{table}

\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/ZenithCorrelation_g.png}
  \caption{Correlation for band 1. \label{fig:Band1Corr} } 
\end{figure}

\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/ZenithCorrection.eps}
  \caption{Bright pixel for 9 different scenes. \label{fig:ZenithCorr} } 
\end{figure}
Because the Landsat reflectance products was not available for Landsat 8 at the moment of starting this research, it was necessary to estimate a theoretical reflectance value for the coastal band for Landsat 5 in order to match with the Landsat 8 bands. To accomplish this, it was assumed that the coastal band would exhibit a similar trend as the blue and green bands. Hence, a straight-line that passes through the blue and green band values was used to extrapolate the value of the coastal band, as seen in \autoref{fig:Extrapol}, where the estimation of this reflectance value for the coastal band is shown at $443 [nm]$ and the straight-line is shown as a black solid line. At the moment of writing this document, the surface reflectance product was available for Landsat 8. Therefore, the Landsat 8 reflectance could be used directly, and the previous step was not necessary. It was found that this assumption was pretty close to the real values in the Landsat 8's coastal band. Finally, the reflectance spectra for the bright pixel is shown in \autoref{tab:brightref}. As was mentioned previously, the radiance spectra for the bright pixel is obtained by applying the master PIF mask to the Landsat 8 image (see \autoref{fig:PIFstats}.(b)).

\begin{table}[htb]
\caption{ Reflectance spectra for the bright pixel. \label{tab:brightref} } 
\centering
\begin{tabular}{l|c} 
 \bfseries{Band} & \bfseries{Reflectance values}\\ \hline \hline
 Band 1 (Coastal Band) &  0.0965 \\
 Band 2 (Blue Band) &  0.1039 \\
 Band 3 (Green Band) &  0.1186 \\
 Band 4 (Red Band) &  0.1270 \\
 Band 5 (NIR Band) &  0.1601 \\
 Band 6 (SWIR 1 Band) &  0.1650 \\ 
 Band 7 (SWIR 2 Band) &  0.1539 \\ 
 \end{tabular}
\end{table}

\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/Extrapolation.eps}
  \caption{Extrapolation for the coastal band. \label{fig:Extrapol} } 
\end{figure}

\subsubsection{Black Pixel Determination}
\label{subsubsec:blackpixel}
The reflectance spectra for the dark pixel is obtained from Ecolight, which is a version of Hydrolight that runs faster because it only calculates the radiance for the nadir angle and not in all directions \citep{MobleyHEtech}. This Ecolight run represents a ROI present in the Landsat 8 radiance image. IOPs and concentrations measurements taken in the field from the same ROI are input to Ecolight. The Case 2 model in Ecolight is used to generate a remote sensing reflectance ($R_{rs}$). This model is a generic four-component (pure water, chlorophyll-bearing particles, CDOM, and mineral particles) IOP model \citep{MobleyHEtech}. Note that for this research the mineral particles component defined in Hydrolight are replaced by the suspended materials (SM) defined in previous sections. The terms mineral particles and \gls{sm} will be used interchangeable in this research. The difference between both terms is that suspended materials include both organic and inorganic particles, and not only minerals. The Case 2 model in Ecolight requires specification of the IOPs of each component one at a time. This includes concentration, absorption and scattering coefficient spectra and phase function for each component. It is worthy to mention that in this research, the concentrations and absorption coefficients for each CPA are measured, scattering coefficients were available from previous work, but phase function for each CPA was not measured, or available. Therefore, the phase function information needs to be determined (page \pageref{pag:phasefn}). The IOPs for each CPA provided to Ecolight that are used to generate the reflectance spectra for the dark pixel are explained below.

\autoref{tab:ONTNSconc} shows the constituent concentrations for two different water samples from the data collection on September, 19th, 2013. These concentrations were obtained from lab measurement at RIT (see Appendix~\ref{ch:labmea} for details about lab measurements). These water samples were collected from the nearshore of Lake Ontario (labeled as ONTNS) and from the southern part of Long Pond (labeled as LONGS), and they represent two scenarios with totally different characteristics. The water sample ONTNS was used to generate the reflectance spectra for the dark pixel in Ecolight. The concentrations for each component were set to be constant with depth with the values shown in \autoref{tab:ONTNSconc}. 
\vspace{.5cm}
\begin{table}[!ht]
\caption{ Water samples concentration for the September, 19th, 2013 collections. \label{tab:ONTNSconc} } 
\centering
\begin{tabular}{c|c|c|c} 
 \bfseries{Sample} & \bfseries{$X_{Chl}$} & \bfseries{$a(\lambda_0=440)$}& \bfseries{$X_{SM}$}\\
 & $[\mu g/L]$ & $[1/m]$ & $[mg/L]$ \\ \hline \hline
ONTNS & 0.48 & 0.1151 & 1.6\\ 
LONGS & 112.76 & 1.1953 & 46.0\\ 
 \end{tabular}
\end{table}

The absorption properties for the component chlorophyll were input by user-supplied data files containing mass-specific absorption coefficients as a function of wavelength. These mass-specific absorption spectra are shown in \autoref{fig:CHLabast}.(a). These data were obtained from lab measurements of absorption coefficient spectra for the water sample ONTNS with a spectrophotometric method (see Appendix~\ref{ch:labmea} for method details). The spectrophotometric method yields absorption coefficients, which are converted to mass-specific absorption coefficients by dividing the absorption coefficient spectra by the concentration. The chlorophyll concentration was determined in the lab by a spectrophotometric method as well. For the chlorophyll scattering properties, the same mass-specific scattering coefficient data used in \citet{Raqueno:2000} and \citet{Raqueno:2003} were utilized. These data are shown in \autoref{fig:CHLabast}.(b). A Fournier-Forand (FF) phase function with backscatter fraction 0.010 was selected as the phase function for the chlorophyll. The details about the selection of this phase function will be described below (page \pageref{pag:phasefn}).
\begin{figure}[htb]
  \begin{minipage}[c]{0.48\linewidth}
    \centering
  	\includegraphics[width=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/CHLaastJavier_g.png}
    \centerline{(a)}\medskip
  \end{minipage}
  \hfill
  \begin{minipage}[c]{0.48\linewidth}
    \centering
  	\includegraphics[width=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/CHLbastRolo_g.png}
    \centerline{(b)}\medskip
  \end{minipage}
  \caption{Chlorophyll IOPs. Chlorophyll mass-specific (a) absorption and (b) scattering spectra used for the determination of the reflectance spectra of the dark pixel in Hydrolight. \label{fig:CHLabast} }   
  % \caption{Chlorophyll mass-specific scattering spectra used for the determination of the reflectance spectra of the dark pixel in Hydrolight. \label{fig:CHLabast}} 
\end{figure}

For the CDOM component, the absorption specification was the following. First, the absorption coefficients were determined by spectrophotometric measurements in the lab for the ONTNS water sample (see Appendix~\ref{ch:labmea} for details about lab measurements). These data are shown in \autoref{fig:CDOM_IOP}.(a). Then, the data were normalized by the absorption value $a(\lambda_0)=0.1151[1/m]$ at the reference wavelength $\lambda_0=440nm$, so that $a^*(\lambda_0)=1$. These normalized data are shown in \autoref{fig:CDOM_IOP}.(b) as purple dots. An exponential curve with the following equation
\begin{equation}
	\label{eq:CDOMabs}
	a^*(\lambda)=a^*(\lambda_0)\exp{\left[-\gamma(\lambda-\lambda_0)\right]}
\end{equation}
was fitted to the normalized data. It was determined that the decay constant $\gamma=0.0126$. The fitted curve is illustrated in \autoref{fig:CDOM_IOP}.(b) in solid line. The parameters of this fitted curve are input in Ecolight to specify the CDOM specific absorption $a^*$, and $a(\lambda_0)=0.1151[1/m]$ to specify the dependence of the CDOM absorption at a reference wavelength.

\begin{figure}[!ht]
  \begin{minipage}[c]{0.48\linewidth}
  	\centering
  	\includegraphics[width=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/ONTNS_CDOMabs.eps}
    \centerline{(a)}\medskip
  \end{minipage} 
  \hfill 
  \begin{minipage}[c]{0.48\linewidth}
  	\centering
  	\includegraphics[width=7cm]{./Images/ONTNS_CDOMfitting_g.eps}
    \centerline{(b)}\medskip
  \end{minipage}    
  \caption{CDOM IOPs. CDOM (a) absorption coefficient spectra and (b) mass-specific absorption spectra used for the determination of the reflectance spectra of the dark pixel in Hydrolight. \label{fig:CDOM_IOP} } 
  % \caption{CDOM mass-specific absorption spectra used for the determination of the reflectance spectra of the dark pixel in Hydrolight. \label{fig:CDOMaast} }
\end{figure}

The SM mass-specific absorption coefficient was determined by dividing the absorption coefficients measured in the lab from the water ONTNS water sample by the \gls{tss}, also measured in the lab (see Appendix~\ref{ch:labmea} for details about lab measurements). The SM mass-specific absorption coefficients are shown in \autoref{fig:SMabast}.(a). The SM mass-specific scattering coefficients were the same used by \citet{Raqueno:2000} and \citet{Raqueno:2003} and are shown in \autoref{fig:SMabast}.(b).

\begin{figure}[!ht]
  \begin{minipage}[c]{0.48\linewidth}
  	\centering
  	\includegraphics[width=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/SMaastJavier_g.png}
    \centerline{(a)}\medskip
  \end{minipage}     
  \hfill
  \begin{minipage}[c]{0.48\linewidth}
  	\centering
  	\includegraphics[width=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/SMbastRolo_g.png}
    \centerline{(b)}\medskip
  \end{minipage} 
  \caption{Mineral mass-specific (a) absorption and (b) scattering spectra used for the determination of the reflectance spectra of the dark pixel in Hydrolight. \label{fig:SMabast} }     
  % \caption{Mineral mass-specific scattering spectra used for the determination of the reflectance spectra of the dark pixel in Hydrolight. \label{fig:SMbast} } 
\end{figure}

The following approach was used to determine phase function\label{pag:phasefn} for both the chlorophyll and mineral particle components. Ecolight was run several times with the different phase functions from the library of discretized Fournier-Forand phase functions files supplied with Ecolight 5.2 to create a LUT of reflectance spectra, but maintaining the rest of the parameters the same. These parameters corresponded to the ONTNS water sample. The different reflectance spectra generated as output were compared with the reflectance measured {\it in situ}. The best match was determining by choosing the lowest root mean squared error (RMSE) between the reflectance measured {\it in situ} and the simulated reflectance spectra.

It was determined that the best matched corresponds to the discretized Fournier-Forand phase function with a backscatter equal to $0.010$, i.e. $1\%$ of backscatter fraction (file FFbb010.\-dpf in Ecolight). Therefore, this discretized Fournier-Forand phase function is used for both the chlorophyll and SM. \autoref{fig:BestMatchONTNS} illustrates the reflectance measured {\it in situ} (red solid line) and the best match reflectance from the LUT (blue solid line), generated with a discretized Fournier-Forand phase function of 0.010 backscatter fraction. It can be seen in \autoref{fig:BestMatchONTNS} that both spectra agree in values above $550nm$, but not below this wavelength. This suggests that there is still room for improvement in the determination of the phase function and rest of the parameters in the Ecolight model.

The following parameters were input to Ecolight in order to simulate the Landsat acquisition conditions. The illumination conditions were input to Ecolight by specifying the solar zenith angle and day of the year that matched the Landsat 8 image. Internal sources and inelastic scatter were not included in the simulations. The wavelength range was $[400nm,1000\-nm]$, with a $1nm$ step. Default values for the air-water surface conditions were used, with a windspeed equal to $5m/s$, a real index of refraction equal to $n=1.34$, and the semi-empirical sky model (based on RADTRAN-X). Recall that Hydrolight uses a Cox-Munk air-water surface model that parameterizes gravity and capillary waves via the wind speed \citep{Cox1954_mea_sea,Cox1954_stats_sea_surf}. Finally, the bottom boundary condition used was ``the water column is infinitely deep.''

The best matched spectra in the LUT is used as the reflectance spectra of the dark pixel in the MoB-ELM method. This reflectance is further spectrally sampled to the Landsat 8 response using the OLI's sensor response obtained from ENVI. 

\begin{figure}[htb]
  	\centering
  	\includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/RefWithFFbbONTNS.eps}
  \caption{Reflectance for ONTNS sample and best matching from Hydrolight. \label{fig:BestMatchONTNS} } 
\end{figure}

The radiance spectra for the dark pixel is obtained from the corresponding ROI in the water present in the Landsat 8 image, from where the {\it in situ} IOP data used in Hydrolight were taken. Statistics are computed in this dark region, and the mean values in each band are used as the radiance spectrum for the dark pixel. An example of a ROI over water is shown in \autoref{fig:ENVIROI_darkpx}, along with its statistics calculated in ENVI.

As an example, \autoref{fig:ELMpxsENVI} shows the different spectra used to perform the MoB-ELM, where four different spectra can be seen: one reflectance and one radiance spectra for the bright pixel (obtained using the PIF extraction over the Landsat reflectance product and Landsat 8 image, respectively), one reflectance spectra for the dark pixel (obtained from Ecolight/Hydrolight), and one radiance spectra for bright pixel (obtained from the statistics of a ROI over water in the Landsat 8 image). These spectra are used to atmospherically correct the Landsat 8 image using the ENVI Classic software \citep{ENVIUserGuide}. This is performed using the ``Empirical Line'' algorithm of the ``Calibration Utilities'' in ENVI classic, where the Landsat 8 image is used as the input image, and the reflectance spectra are labeled as ``field spectra'' and the radiance spectra are labeled as ``data spectra.'' The product of this process is an image in reflectance values, which will be used to perform the retrieval of water constituents described in \S\ref{sec:retrieval} below. Note that the Landsat 8 image used was not glint corrected.

One of the great values of this approach is that it can correct for slight mismatches between the model and observations such as shown in \autoref{fig:BestMatchONTNS}. Because the dark reflectance uses a model derived spectrum, it will pull all the atmospherically corrected data up slightly at the shorter wavelengths, which will be a better match to the model based LUT that will be used to generate the CPAs.

\noindent {\bf MoB-ELM Correction Summary:}
\begin{enumerate}[itemsep=2pt,parsep=2pt]
  \item Select reflectance of the bright pixel from the Landsat 8 Surface Reflectance \gls{cdr} product by using a PIF mask or a particular target
  \item Obtain radiance of the bright pixel from corresponding target in the Landsat 8 image
  \item Select dark pixel from a Hydrolight run using {\it in situ} IOPs
  \item Obtain radiance of the dark pixel from corresponding target in the Landsat 8 image
  \item Use ENVI's Empirical Line tool with the bright and dark pixel obtained in previous steps
\end{enumerate}

\begin{figure}[htb]
    \centering
    \includegraphics[width=12cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/ENVI_ROIdarkpx}
  \caption{The radiance of the dark pixel is obtained over a ROI over water (red square) of the radiance Landsat 8 image. The mean value of this ROI is used as dark pixel.\label{fig:ENVIROI_darkpx} } 
\end{figure}
\begin{figure}[htb]
  \centering
  \includegraphics[width=14cm,clip=true]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/ELMpixelsENVI.pdf}
  \caption{Bright and Dark pixels used in ENVI to apply the MoB-ELM. \label{fig:ELMpxsENVI} } 
  % \vspace{0.5cm}
\end{figure}

% ----------------------------
\subsection{SeaWiFS Algorithm for Case 1 Waters}
\label{subsec:gordon}
The following algorithm is based on the method developed by \citet{Gordon:1994}\index{atmospheric correction!Gordon and Wang method} for retrieval of water-leaving radiance and aerosol optical thickness over the oceans with \gls{seawifs}. The method developed by \citet{Gordon:1994} is still applied to the basic SeaWiFS and \gls{modis} atmospheric correction algorithms for Case 1 water \citep{IOCCG:2010}.

The first step in this algorithm is performing a Rayleigh scattering correction, which means to subtract the reflectance due to Rayleigh scatter $\rho_r$ from the total TOA reflectance $\rho_t$ in \autoref{eq:rhodeglint}. In the SeaWiFS/MODIS algorithm, the Rayleigh scatter component is computed from the Rayleigh LUTs, which were calculated using the vector radiative transfer theory \citep{Wang:1991,IOCCG:2010}. For this work, one alternative could have been to calculate this Rayleigh scattering component $\rho_r$ directly from the \gls{modtran} software for the particular illumination and viewing geometry of the sun and the sensor in multiple-scatter mode but without aerosol. \gls{modtran} is a computer program designed to model atmospheric propagation of electromagnetic radiation \citep{Berk:1989fk}\index{MODTRAN} (more info: \url{http://www.modtran5.com/}). It was decided to use the \gls{seadas} tool instead, which has the atmospheric LUTs built-in. In the SeaWiFS/MODIS atmospheric correction algorithm, the whitecap reflectance $\rho_{wc}(\lambda)$ (including glint) is modeled using input of the sea surface wind speed, and the TOA sun glint component is mostly masked out \citep{IOCCG:2010}. After calculating this Rayleigh scatter and whitecap component, \autoref{eq:rhodeglint} becomes 
\begin{equation}\label{eq:rhodeRayliegh}
 \rho_c(\lambda) = \rho_t(\lambda)-\rho_r(\lambda)-T_v(\lambda)\rho_{wc}(\lambda) = \rho_a(\lambda)+\rho_{ra}(\lambda)+T_v(\lambda)\rho_{w}(\lambda)
\end{equation}
where $\rho_c(\lambda)$ is the Rayleigh-corrected reflectance. 

If we define the total \gls{rhoam}\index{reflectance!multiple-scattering aerosol, $\rho_{am}$} as
\begin{equation}\label{eq:rhoam1}
  \rho_{am}(\lambda) = \rho_a(\lambda)+\rho_{ra}(\lambda)
\end{equation}
then \autoref{eq:rhodeRayliegh} becomes
\begin{equation}\label{eq:rhoam}
 \rho_c(\lambda) = \rho_{am}(\lambda) + T_v(\lambda)\rho_{w}(\lambda)
\end{equation}

The following approach is taken in the SeaWiFS/MODIS atmospheric correction algorithm to retrieve $\rho_w$. For Case 1 water (e.g. open ocean), the contribution of the water $\rho_{w}$ to the total reflectance $\rho_t$ in the NIR is negligible. This fact is used to estimate $\rho_{am}$ in the NIR bands, and then these results are extrapolated to the visible bands using aerosol modeling (\autoref{fig:epsilonvslambda}). Finally, if $T_v$ is estimated, the $\rho_w$ in the visible bands can be computed.

There are two different approaches to determine the $\rho_{am}(\lambda)$ term at this point. The first one is to use a single-scattering approximation for $\rho_{am}(\lambda)$. The second one is to determine the multiple-scattering term $\rho_{am}(\lambda)$ based on the single scattering approximation, assuming that there exist a linear relationship between them. Both approaches are described below.

% -------------------
\subsubsection{Single Scattering approach to determine \texorpdfstring{$\rho_{am}(\lambda)$}{aerosol contribution}}
\label{subsubsec:singlescat}
The aerosol is highly variable, and unlike the Rayleigh scattering component $\rho_r$, its effect in the total signal cannot be known {\it a priori} \citep{Gordon:1994}. One of the first efforts to overcome this problem was developed for the \gls{czcs} atmospheric correction algorithm using a single-scattering approximation for calculating the aerosol effect in the total signal. Its logic is as follow. If the optical thickness of the atmospheric is considered $<<1$, then the term $\rho_a$ can be replaced by is single-scattering value $\rho_{as}$ (the $\rho_{ra}$ term is ignored since it is a term related to multiple scattering). Using the \gls{rhoas}\index{reflectance!single-scattering aerosol, $\rho_{as}$} in \autoref{eq:rhoam1}, then
\begin{equation}\label{eq:singleapprox}
  \rho_{am}(\lambda) = \rho_a(\lambda)+\cancel{\rho_{ra}(\lambda)} \approx \rho_{as}(\lambda)
\end{equation}
where
\begin{equation}\label{eq:rhoas}
  \begin{gathered}
    \rho_{as}(\lambda) = \frac{\omega_a(\lambda)\tau_a(\lambda)p_a(\theta,\theta_0,\lambda)}{4\cos(\theta)\cos(\theta_0)},\\  
    p_a(\theta,\theta_0,\lambda) = P_a(\theta_{-},\lambda) + [r(\theta)+r(\theta_0)]P_a(\theta_{+},\lambda),\\
    \cos(\theta_{\pm}) = \pm \cos(\theta_0)\cos(\theta)-\sin(\theta_0)\sin(\theta)\cos(\phi-\phi_0)
  \end{gathered}
\end{equation}
and $r(\lambda)$ is the Fresnel reflectance of the interface for an incident angle $\theta$, $\tau_a(\lambda)$ is the aerosol optical thickness, $\omega_a(\lambda)$ is the aerosol single-scattering albedo, $P_a(\alpha,\lambda)$ is the aerosol scattering phase function for a scattering angle $\alpha$, $\theta_0$ and $\phi_0$ are the zenith and azimuth angles from the target to the sun, respectively, and $\theta_0$ and $\phi_0$ are the zenith and azimuth angles from the target to the sensor, respectively. 


For Case 1 waters, the term $\rho_{w}$ is assumed to be zero for NIR bands. If we take the SeaWiFS case for band 7 ($\lambda_7=765nm$) and band 8 ($\lambda_8=865nm$), from \autoref{eq:rhoam}
\begin{equation}\label{eq:seawifsam7}
    \rho_{am}^{(7)} = \rho_{c}^{(7)} = \rho_{as}^{(7)},
\end{equation}
\begin{equation}\label{eq:seawifsam8}
    \rho_{am}^{(8)} = \rho_{c}^{(8)} = \rho_{as}^{(8)},
\end{equation}
where $\rho_{x}^{(i)}$ denotes a reflectance at band $i$ with wavelength $\lambda_i$. \autoref{eq:seawifsam7} and \autoref{eq:seawifsam8} mean that the aerosol reflectance term for band 7 and band 8 in SeaWiFS is equal to only the Rayleigh-corrected reflectance, which is known from the image. Now, we need to find a way to use this result to calculate the atmospheric reflectance for the rest of the bands.

\citet{Gordon:1994} define the atmospheric correction parameter named \gls{sse}\index{single scattering epsilon (SSE), $\varepsilon$} $\varepsilon(\lambda_s,\lambda_l)$ \citep{IOCCG:2010} as
\begin{equation}\label{eq:espilon}
  \varepsilon(\lambda_s,\lambda_l) \equiv \frac{\rho_{as}(\lambda_s)}{\rho_{as}(\lambda_l)} = \\
  \frac{\omega_a(\lambda_s)\tau_a(\lambda_s)p_a(\theta_v,\phi_v;\theta_0,\phi_0;\lambda_s)}{\omega_a(\lambda_l)\tau_a(\lambda_l)p_a(\theta_v,\phi_v;\theta_0,\phi_0;\lambda_l)}
\end{equation}
where the indexes ``$s$'' and ``$l$'' stand for short and long wavelength, associated with the NIR bands, i.e. $\lambda_s=756nm$ and $\lambda_l=865nm$ for SeaWiFS. If the value of $\varepsilon(\lambda_i,\lambda_l)$ for the \gls{vis} band at $\lambda_i$ can be computed from $\varepsilon(\lambda_s,\lambda_l)$, then $\rho_{as}(\lambda_i)$ can be determined as
\begin{equation}\label{eq:rholambda_i}
  \rho_{as}(\lambda_i) = \varepsilon(\lambda_i,\lambda_l)\rho_{as}(\lambda_l),
\end{equation}

The next step is find a way to relate $\varepsilon(\lambda_i,\lambda_l)$ from $\varepsilon(\lambda_s,\lambda_l)$. \citet{Gordon:1994} tried to find a relationship by computing  $\varepsilon(\lambda_i,\lambda_l)$ for several aerosol models that were developed by \citet{Shettle:1979} for the LOWTRAN-6 model. \autoref{fig:epsilonvslambda} shows sample results for $\varepsilon(\lambda_i,\lambda_l)$ for SeaWiFS for these different aerosol models, where $\lambda_l=865nm$. It can be seen that over the range $412-865nm$, $\varepsilon(\lambda_i,\lambda_l)$ can be described as
\begin{equation}\label{eq:epsilonexp}
  \varepsilon(\lambda_i,\lambda_l) = \frac{\rho_{as}(\lambda_i)}{\rho_{as}(\lambda_l)} \approx exp[c(\lambda_i-\lambda_l)]
\end{equation}
where $c$ is a constant that depends on the viewing geometry and the aerosol model. 

\begin{figure}[htb]
  \centering
  \includegraphics[width=11cm,clip=true]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/epsilonvslambdaGordon.png}
  \caption{$\varepsilon(\lambda,\lambda_l)$ values in natural logaritmic scale for different aerosol models and relative humidity (Note: image taken from \citet{Gordon:1997}). \label{fig:epsilonvslambda} } 
  % \vspace{0.5cm}
\end{figure}

The constant $c$ can be calculated using the known value $\varepsilon(\lambda_s,\lambda_l)$ for the NIR bands using \autoref{eq:seawifsam7} and \autoref{eq:seawifsam8}. If $c$ is known then \autoref{eq:rholambda_i} becomes
\begin{equation}\label{eq:rholambda_ifinal}
  \rho_{as}(\lambda_i) = exp[c(\lambda_i-\lambda_l)]\rho_{as}(\lambda_l),
\end{equation}

Once the aerosol single-scattering contribution is determined for the visible bands, $\rho_w$ can be calculated using \autoref{eq:rhoam}, but assuming $\rho_{am}(\lambda)\approx\rho_{as}(\lambda)$. 

The single-approximation is no longer an adequate approximation in cases where the aerosols are not at least moderately absorbing (i.e. strong continental influence) or $\tau_a(\lambda)$ is sufficiently large. Therefore, a full multiple-scattering approach is needed for a more general application.



%where $\rho_{as}^{(i)}$ for band $i$ is the single-scattering aerosol reflectance and $I=1..N$ denominates a set of $N$ simulated aerosol models obtained from, for example, an atmospheric radiative transfer model such as MODTRAN. This set of simulated aerosol models could be MODTRAN runs for different combination of particle size distribution (e.g. maritime, tropospheric, coastal, or urban), relative humidity, visibility, water vapor, etc., to simulate different atmosphere conditions that can occur in the scene.
% -------------------
\subsubsection{Multiple Scattering approach to determine \texorpdfstring{$\rho_{am}(\lambda)$}{aerosol contribution}}
As mentioned  previously, we need to calculate the total multiple-scattering aerosol reflectance $\rho_{am}$ in order to obtain the desired water-leaving reflectance $\rho_w$. The multiple-scattering depends significantly on the aerosol model \citep{Gordon:1997}. In the single-scattering approach previously described, the multiple-scattering was ignored and specific aerosol properties were not needed for the atmospheric correction. On the other hand, if we want to include the multiple-scattering effects in the atmospheric correction algorithm in order to obtain more accurate water reflectance $\rho_w$, it is necessary to utilize specific aerosol models. As a way to use the same reasoning used in the single-scattering algorithm, we can define multiple-scattering term as
\begin{equation}\label{eq:multscat}
  \rho_a(\lambda) + \rho_{ra}(\lambda) = K[\lambda,\rho_{as}(\lambda)]\rho_{as}(\lambda)
\end{equation}
where $K$ represents the relationship between the multiple-scattering and single-scattering. \citet{Wang:1991} has shown that a monotonic near-linear relation exists between $\rho_a(\lambda)+\rho_{ra}(\lambda)$ for the multiple-scattering model and $\rho_{as}(\lambda)$ for the single-scattering model. \citet{Gordon:1994} provided a LUT for $K[\lambda,\rho_{as}(\lambda)]$ by solving the \gls{rte} of a set of $N$ candidate aerosol models. These aerosol models were from, or derived from, the work of \citet{Shettle:1979}. The aerosol models are Oceanic, Maritime, Coastal and Tropospheric for different values of \gls{rh}. The LUT was created for different sensor-sun geometry, single-scattering albedo and \AA ngstr\"{o}m exponent. The RTE is solved by using vector radiative transfer \citep{IOCCG:2010}. For the SeaWiFS/MODIS algorithm, the $\rho_a(\lambda)+\rho_{ra}$ value for a given geometry is fit to a fourth order polynomial in the single-scattering aerosol reflectance $\rho_{as}(\lambda)$, i.e.,
\begin{equation}\label{eq:polynomial}
  \rho_a+\rho_{ra} = a\rho_{as}+b\rho_{as}^2+c\rho_{as}^3+d\rho_{as}^4
\end{equation}
where $a$, $b$, $c$ and $d$ are the constants contained in the LUT for a large number of viewing-sun geometries and for values of $\tau_a(\lambda)$ up to $0.8$.

Similar to the single-scattering approach, the assumption of negligible $\rho_w$ in the NIR allows us to determine the quantities $\rho_a(\lambda_s)+\rho_{ra}(\lambda_s)$ and $\rho_a(\lambda_l)+\rho_{ra}(\lambda_l)$ in the NIR. Once these quantities are determined from the sensor-measured values, the $\rho_{as}(\lambda)$ values for the NIR bands are estimated from these quantities using the LUT. Furthermore, because $\rho_{as}(\lambda)$ depends on aerosol phase function, single-scattering albedo, and optical thickness, this value can be computed for each aerosol model. Then, the \gls{sse}  values (described in \S\ref{subsubsec:singlescat}) for the NIR bands (i.e. $\varepsilon(\lambda_s,\lambda_l)$) can be calculated from the single-scattering reflectance values for each aerosol model and the measured values using \autoref{eq:espilon}. 

In order to determine multiple-scattering values in the VIS, the most appropriate aerosol models are selected by comparing the SSE computed from the sensor-measured values with the ones computed from each aerosol model. This is accomplished in the following fashion. After deriving $\varepsilon(\lambda_s,\lambda_l)$, the next step is to estimate $\varepsilon(\lambda_i,\lambda_l)$. $\varepsilon(\lambda_s,\lambda_l)$ falls between those for two of the $N$ aerosol models. Therefore, $\varepsilon(\lambda_i,\lambda_l)$ is assumed to fall between the same two aerosol models proportionately in the same manner as $\varepsilon(\lambda_s,\lambda_l)$. Then, \autoref{eq:rholambda_i} is used to estimate single-scattering value in the rest of the bands from $\rho_{as}(\lambda_l)$. 

Finally, the LUT is used to transform single-scattering to multiple-scattering values to obtain $\rho_{am}(\lambda)$ and using \autoref{eq:rhoam} to obtain $\rho_w(\lambda)$. 

A summary of the method developed by \citet{Gordon:1994} is described below.

\noindent {\bf SeaWiFS/MODIS Atmospheric Correction Summary:}
\begin{enumerate}[itemsep=2pt,parsep=2pt]
  \item Enter the atmospheric correction routine with Rayleigh-corrected reflectances $\rho_c(\lambda_s)$ and $\rho_c(\lambda_l)$.
  \item Assuming water-leaving reflectances for NIR bands are equal to zero, set multiple-scattering aerosol reflectances $\rho_{am}(\lambda_s)$ and $\rho_{am}(\lambda_l)$ equal to Rayleigh-corrected reflectances.
  \item Using the aerosol LUTs, calculate the corresponding single-scattering aerosol value at the two NIR bands, i.e. $\rho_{as}(\lambda_s)$ and $\rho_{as}(\lambda_l)$. Then, calculate the corresponding SSE.
  \item For each $N$ aerosol, compute the single-scattering value using \autoref{eq:rhoas}. Calculate corresponding SSE.
  \item Select the best two aerosol models by comparing the retrieved SSE with the theoretical SSE and determine the interpolation ratio between them.
  \item For the optimal aerosol model use the tabulated $\varepsilon(\lambda)$ in the VIS and $\varepsilon(\lambda_l)$ to obtain $\rho_{as}(\lambda)$ and then $\rho_{am}(\lambda)$ in the VIS using \autoref{eq:rholambda_i} and the LUT.
  \item Remove $\rho_{am}(\lambda)$ in the VIS from $\rho_c(\lambda)$ and divide by the corresponding atmospheric transmittance that corresponds to the best aerosol model to return $\rho_w(\lambda)$ in the VIS using \autoref{eq:rhoam}.
\end{enumerate}

% ------------------------------
\subsection{SeaWiFS Algorithm for Case 2 Water}
\label{subsec:ruddick}

The next atmospheric correction method is based on the method developed by \citet{Gordon:1994} for ocean color satellites (\S\ref{subsec:gordon}), and extended by \citet{Ruddick:2000bs} for use over turbid coastal and inland waters (Case 2) or high productive Case 1 waters. As stated previously, the methods developed by \citet{Gordon:1994} assumes a zero water-leaving radiance for the NIR bands, which is not valid for highly turbid coastal and inland waters. Backscatter from particles in these waters could contribute to signal in the NIR bands, causing an over-estimation of the aerosol contribution and therefore an under-estimation of the water-leaving reflectances, even leading to negative values in the visible, which is not possible. 

In order to overcome this problem, \citet{Ruddick:2000bs} replaced the black water assumption with two assumptions: the assumption of spatial homogeneity of the SeaWiFS's NIR bands ratio ($765:865-nm$) for aerosol reflectance and for water-leaving reflectance. These two ratios are used as calibration parameters after inspection of the Rayleigh-corrected reflectance scatterplot. The algorithm is described in more details below.

In order to extend the standard atmospheric correction procedure to turbid water, two assumptions are used:

\begin{enumerate}[itemsep=2pt,parsep=2pt]
  \item At least over the ROI, the calibration parameter $\varepsilon_m(\lambda_s,\lambda_l)$, defined as the ratio of multiple-scattering aerosols and aerosol-Rayleigh reflectances at the NIR bands, is assumed to be spatially homogeneous, i.e.
  \begin{equation}\label{eq:rhohomo}
    \varepsilon_m(\lambda_s,\lambda_l)\equiv \frac{\rho_{am}(\lambda_s)}{\rho_{am}(\lambda_l)},
  \end{equation}
  and fixed for each image.

  \item The calibration parameter $\alpha$, defined as the ratio of water-leaving reflectances normalized by the sun-sea atmospheric transmittance at the NIR bands $T_0(\lambda)$, is assumed to be spatially homogeneous, i.e.
  \begin{equation}\label{eq:alpha}
    \alpha \equiv \frac{\rho_w(\lambda_s)/T_0(\lambda_s)}{\rho_w(\lambda_l)/T_0(\lambda_l)},
  \end{equation}
  and fixed for each image.
\end{enumerate}

By using these two assumption, the multiple-scattering aerosol and the aerosol-Rayleigh reflectance for the NIR bands can be derived as

\begin{equation}\label{eq:rhoams}
  \rho_{am}(\lambda_s) = \frac{\alpha\rho_c(\lambda_l)-\rho_c(\lambda_s)}{\alpha-\varepsilon_m(\lambda_s,\lambda_l)},
\end{equation}
and
\begin{equation}\label{eq:rhoaml}
  \rho_{am}(\lambda_l) = \varepsilon_m(\lambda_s,\lambda_l)\left[\frac{\alpha\rho_c(\lambda_l)-\rho_c(\lambda_s)}{\alpha-\varepsilon_m(\lambda_s,\lambda_l)}\right],
\end{equation}

Once these aerosol reflectances $\rho_{am}(\lambda_s)$ and $\rho_{am}(\lambda_l)$ are determined, they can be used in the standard algorithm, described in the previous section (instead of $\rho_c(\lambda_s)$ and $\rho_c(\lambda_l)$) to derive $\rho_w(\lambda)$ in the VIS.

\citet{Ruddick:2000bs} suggested a method to determine the calibration parameter $\varepsilon_m(\lambda_s,\lambda_l)$ by inspection of the scatterplot between the Rayleigh-corrected reflectance $\rho_c$ in the NIR bands, as shown in \autoref{fig:ruddickplot}. This assumption is only valid for a small scale space, where the aerosol type varies only weakly in space. As for the calibration parameter $\alpha$, \citet{Ruddick:2000bs} set it to a default value of $1.72$, which is a first-order estimate from a greatly simplified ocean color model. The derivation can be seen in \citet{Ruddick:2000bs} and will not be explained here.

The process is summarized as follows:

\noindent {\bf SeaWiFS/MODIS Atmospheric Correction for Turbid Water Summary:}(\citep{Ruddick:2000bs})
\begin{enumerate}[itemsep=2pt,parsep=2pt]
  \item Enter the atmospheric correction routine to produce a scatter plot of Rayleigh-corrected reflectances $\rho_c(\lambda_s)$ and $\rho_c(\lambda_l)$) for the ROI of study, and select the calibration parameter $\varepsilon_m(\lambda_s,\lambda_l)$. Set calibration parameter $\alpha$ equal to 1.72.

  \item Reenter the atmospheric correction routine with $\rho_c(\lambda_s)$ and $\rho_c(\lambda_l)$ and use \autoref{eq:rhoams} and \autoref{eq:rhoaml} to obtain $\rho_{am}(\lambda_s)$ and $\rho_{am}(\lambda_l)$, taking account of nonzero water-leaving reflectances.

  {\bf Note:} The following steps are the same as the standard algorithm described in \S\ref{subsec:gordon}.

  \item Using the aerosol LUTs, calculate the corresponding single-scattering aerosol value at the two NIR bands, i.e. $\rho_{as}(\lambda_s)$ and $\rho_{as}(\lambda_l)$. Then, calculate corresponding SSE.

  \item For each of the $N$ aerosol types, compute the single-scattering value using \autoref{eq:rhoas}. Calculate corresponding SSE.
  \item Select the best two aerosol models by comparing the retrieved SSE with the theoretical SSE and determine the interpolation ratio between them.
  \item For the optimal aerosol model use the tabulated $\varepsilon(\lambda)$ in the VIS and $\varepsilon(\lambda_l)$ to obtain $\rho_{as}(\lambda)$ and then $\rho_{am}(\lambda)$ in the VIS using \autoref{eq:rholambda_i} and LUT.
  \item Remove $\rho_{am}(\lambda)$ in the VIS from $\rho_c(\lambda)$ and divide by the corresponding atmospheric transmittance that corresponds to the best aerosol model to return $\rho_w(\lambda)$ in the VIS using \autoref{eq:rhoam}.
\end{enumerate}

\begin{figure}[htb]
  \centering
  \includegraphics[width=10cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/RuddickPlot.png}
  \caption{Scatterplot of Rayleigh-corrected reflectances at 765 and 865 nm for a subregion in a SeaWiFS image taken 28 October 1997, 12:15 UTC.  (Note: image taken from \citet{Ruddick:2000bs}). \label{fig:ruddickplot} } 
\end{figure}
% The second atmospheric correction method will be an extension of a method developed for SeaWiFS over turbid coastal and inland waters \citep{Ruddick:2000bs}. This method is a modified version of the methods developed by Gordon \citet{Gordon:1997} for ocean color satellites, but when the signal leaving the water does contribute to the overall signal beyond the NIR part of the spectrum. By using longer wavelengths and restricting the input pixels to open waters, these methods can be  applied to many fresh and coastal regions. The water-leaving reflectance values obtained after atmospheric correction will be validated through comparison to water-leaving reflectance measured in situ. 

% ------------------------------
\subsection{SWIR bands Atmospheric Correction}
\label{subsec:wang}

For Case 2 or highly productive Case 1 waters, especially turbid waters, there is a significant contribution from the water-leaving radiance and hence the zero water-leaving assumption in the NIR bands is not valid anymore. This is often the case in inland and coastal waters and therefore the NIR bands cannot be used to atmospherically correct this kind of imagery. However, these kinds of waters are indeed black in the shortwave infrared (SWIR) bands ($\geq 1000nm$) due to stronger water absorption. So, we can use the same atmospheric correction procedure used for SeaWiFS and MODIS but replacing the NIR bands with the two OLI SWIR bands ($1690$ and $2200nm$) for the data processing, as suggested by \citep{Wang:2007,Wang:2005}. \citet{Wang:2007} evaluated different combinations of the MODIS' SWIR bands to atmospherically correct a specific study image and compared the results with the traditional algorithm (NIR bands). Actually, the latest MODIS atmospheric algorithm uses a NIR-SWIR combined atmospheric correction approach that uses the NIR bands for non-highly productive Case 1 water and the SWIR bands for Case 2 or highly productive Case 1 waters, and a turbidity index to decide when to use them \citep{Wang:2007dz}. 

% ------------------------------
\subsection{OLI Algorithm for Case 2 Waters (Blue Band)}
\label{subsec:blueband}
\index{atmospheric correction!Gerace's blue band}
\citet{GeraceThesis} proposed the use of a combination of spectral matching and band ratio techniques (method developed by \citet{Gordon:1994}) to atmospherically correct OLI data over Case 2 waters. A requirement to use this technique for atmospherically correcting OLI data is $\varepsilon^{(1,6)}\cong constant$, or in other words the ratio of reflectance from OLI's band 1 (coastal band) and band 6 (SWIR 1 band) should be approximately constant for all water pixels in the region of interest. Due to variability in band 1, the previous requirement is not always true. However, this variability can be accounted using spectral matching. This method needs to be applied with caution as it will not work in highly turbid water due to high variability in band 1. Therefore, an {\it a priori} analysis of the band histogram is needed, and only the bands whose histogram has little spread and resemble a normal distribution should be used \citep{GeraceThesis}.

This method first uses forwarding modeling to create a three dimensional (3-D) LUT in Hydrolight. Then, it adds atmospheric visibility as a fourth dimension (4-D). The dimensions of the LUT are concentration of chlorophyll-{\it a}, suspended particles and CDOM. The range of the LUT is made up of spectral water-leaving reflectances. Then, this 3-D reflectance LUT is propagated to the TOA using MODTRAN for a range of visibilities. Therefore, the 4-D LUT will be made up of the independent variables chlorophyll-{\it a}, suspended particles, CDOM and visibility, while the range will be made up of spectral sensor-reaching radiances. A diagram showing the concept of this 4-D LUT appears in \autoref{fig:4DLUT}. Note that this approach requires some knowledge of the aerosol type (e.g. rural, urban, maritime, etc.). Furthermore, the sensor-reaching radiances should be spectrally sampled at the OLI's sensor response and the data from the image should be corrected for the effect of glint before comparing with the 4-D LUT since it does not include this effect.

\begin{figure}[htb]
  \centering
  \includegraphics[width=14cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/ThesisPhD/Images/4DLUT_g.png}
  \caption{Four dimensional LUT. The dimension are concentrations of chlorophyll-{\it a}, suspended particles, CDOM and visibility and the range is spectral sensor-reaching radiance. Source: \citet{GeraceThesis}}
  \label{fig:4DLUT} 
\end{figure}
% \todo{change figure for a better quality}
Once the 4-D LUT has been created, an iterative search of the closest match to an imaged water pixel is performed. The first step in this iteration is to obtain an initial guess of the visibility. To do so an imaged spectrum is compared to the spectra contained in the 4-D LUT. The parameters (concentration of CPAs and visibility) associated with the closest non-interpolated spectrum in the 4-D LUT in a RMS sense are associated with the imaged spectrum. Then, these associated parameters are fixed and the observed $\varepsilon^{(1,6)}$ is compared with the 4-D LUT $\varepsilon^{(1,6)}$ values for different visibilities but the same concentration, and the visibility of the closest match is selected as the initial visibility estimate.

After estimating the initial visibility, an optimization routine can be used to estimate the four parameters from the 4-D LUT by interpolation. The final results of this process are interpolated CPA's concentration and visibility associated with the imaged pixel.

\citet{GeraceThesis} suggested using an average of all visibility solutions obtained previously as a fixed visibility and repeating the estimation described above with this fixed visibility. This is because the atmosphere should not have a high variability in the scene and therefore be approximately constant over the study region.

A summary of this process is described below.

\noindent{\bf Summary:}
Enter the algorithm with glint corrected data:\\
{\bf Step 1:} Using the three dimensions of chlorophyll-{\it a}, particles and CDOM concentrations, create a water-leaving reflectance 3-D LUT using Hydrolight.\\
\noindent{\bf Step 2:} Propagate the 4-D LUT to the TOA using MODTRAN to develop a 4-D LUT of sensor-reaching radiances. Use a best-estimate aerosol type and a range of visibility.\\
\noindent{\bf Step 3:} Search best match of imaged water pixel in the 4-D LUT.\\
\noindent{\bf (a)} Obtain initial guess of the visibility by using spectral matching and epsilon ratios.\\
\noindent{\bf (b)} Search for best match in the 4-D LUT using initial guess of the visibility.\\
\noindent{\bf Step 4:} Obtain average visibility from all the water pixels and repeat search for best match.\\

% ------------------------------
\subsection{OLI Algorithm for Case 2 Waters (Band Ratios)}
\label{subsec:bandratios}
\index{atmospheric correction!Gerace's band ratios}
Another algorithm suggested by \citet{GeraceThesis} uses the concept adopted by \citet{Ruddick:2000bs}, but incorporating OLI's NIR (band 5) and SWIR 1 (band 6) bands instead of the two NIR bands used for SeaWiFS. This algorithm utilizes the concept of band ratios (using the epsilon ratio values) in its implementation for calculating the reflectance due to aerosol in the scene. Recall from \citet{Ruddick:2000bs} that we would like $\varepsilon^{(i,j)}$ to be constant over the region of interest, for some band $i$ and band $j$. 

For this algorithm specifically, the requirement should be $\varepsilon^{(5,6)}\cong constant$. If this is the case for any two bands in the scene, then a band ratio technique (\S\ref{subsec:gordon}, \S\ref{subsec:ruddick} and \S\ref{subsec:wang}) can be used to solve for $\rho_w$ in \autoref{eq:rhoam}. However, the requirement of $\varepsilon^{(5,6)}\cong constant$ could not be true for turbid waters because there is some signal coming from the water in the NIR, not only from the atmosphere, i.e. $\rho_w^{(5)}\neq0$. This fact produces variability in the water reflectance in band 5. Therefore, simply calculating $\varepsilon^{(5,6)}$ will result in a misrepresentation of the atmosphere and the water signal. A solution to this problem is to select the signal in band 5 (NIR band; $862nm$) from a region of dark waters, and make the black pixel assumption in band 6. This will allow one to calculate $\varepsilon^{(5,6)}$ over dark water and therefore determine its atmosphere signal, i.e. the \citet{Ruddick:2000bs} approach adapted to the SWIR region. Then, the whole water scene is assumed to have the chosen atmosphere, the image is atmospherically corrected for that atmosphere. The details of this algorithm are similar to the ones described in \citet{Ruddick:2000bs} (see \S\ref{subsec:ruddick}), and summarized below.

\noindent{\bf Summary:}
Enter the algorithm with glint corrected data:\\
{\bf Step 1:} Create a LUT of aerosol reflectances for different atmospheric models using MODTRAN and Hydrolight to determine $\rho_w$ for a dark water pixel. Then, calculate $\varepsilon^{(5,6)}$ for each atmospheric model in the LUT. \\
\noindent{\bf Step 2:} Calculate an averaged $\varepsilon^{(5,6)}$ from a region of interest over dark water by averaging the reflectance at the TOA ($\rho$) values for that region.\\ 
\noindent{\bf Step 3:} Use the averaged $\varepsilon^{(5,6)}$ to find the closest two matches for the modeled atmosphere in the LUT from Step 1 and calculate the interpolation ratio between these two matched and the averaged $\varepsilon^{(5,6)}$. \\
\noindent{\bf Step 4:} Extrapolate the determined model to all wavelengths using interpolation ratio. \\
\noindent{\bf Step 5:} Globally correct the scene for the atmospheric effect. \\

% ------------------------------
\subsection{Concluding Remarks}
The developed \gls{mobelm} atmospheric correction described in \S\ref{subsec:mobelm} is used to test the methodology. The atmospheric correction algorithms based on \citet{Gordon:1994} are used to compare with the developed algorithm, but they are applied directly from the \gls{seadas} and \gls{acolite} tools. Finally, the algorithm proposed by \citet{GeraceThesis} (\S\ref{subsec:blueband} and \S\ref{subsec:bandratios}) are not used. They were described here for reference.
% @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
\section{In-Water Constituent Retrieval Process}
\label{sec:retrieval}
The retrieval algorithm will be based on previous work done by \citet{Raqueno:2000}, \citet{Gerace:2013} and \citet{Concha2013IGARSS}. The water-leaving reflectance product (or \acrshort{rrs} product) obtained after atmospheric correction from the previous stage is used as input to the retrieval algorithm (\autoref{fig:detailflowchart}). Each water pixel in the \acrfull{rhow} product has an unknown concentration. A spectral matching technique is applied to predict this concentration by comparing the spectral shape of each pixel with the elements in a \gls{lut}. The complete retrieval process will be explained in the following sections. 
% -------------------------------------
\subsection{LUT generation}
\label{subsec:LUTgen}
The \gls{lut} is generated in Ecolight \citep{MobleyHE} for different triplets of water constituent concentrations (CPAs). Ecolight was used in the same fashion as in the black pixel determination for the MoB-ELM algorithm (\S\ref{subsubsec:blackpixel}). As an example, \autoref{tab:LUTconc2} shows the different parameters used to create a LUT in Ecolight. Two different sets of {\it in situ} IOPs (mass-specific absorption and scattering coefficient spectra) were used, one set for modeling the open lake conditions (low concentration of CPAs) and one set for modeling the pond condition (high concentration of CPAs). The set of IOPs are specific and unique for each image. These IOPs are labeled in \autoref{tab:LUTconc2} as ``ONTNS'' for the open lake conditions and as ``LONGS'' for the pond conditions. \autoref{tab:LUTconc2} also shows the CPAs concentration used to create the LUT in Ecolight, where $C_a$ is the chlorophyll-{\it a} concentration, \acrfull{tss}, $a_{CDOM}(440)$ is the CDOM absorption coefficient at the wavelength $\lambda=440nm$. Furthermore, discretized Fournier-Forand phase functions with four different \acrfull{b_boverb} values ($0.5$, $1.0$, $1.5$ and $2.0\%$) were used to account for the backscattering variability in the scene.


\begin{table}[htb]
\caption{ Input parameters for the LUT generation in Ecolight. \label{tab:LUTconc2} } 
\centering
		\begin{tabular}{ccccc}
    \hline \hline
    \multirow{2}{*}{IOPs Input} & \bfseries{$C_a$}  	& \bfseries{$TSS$}  & \bfseries{$a_{CDOM}(440)$} & \bfseries{$b_b/b$}\\
		           & $[mg~m^{-3}]$   		& $[g~m^{-3}]$      & 	$[1/m]$                  &	$[\%]$	         \\ \hline \hline
\multirow{7}{*}{ONTNS} & 0.1   & 1.0  &  0.11 &  0.5 \\
                       & 0.5   & 2.0  &  0.15 &  1.0 \\
                       & 1.0   & 5.0  &  0.21 &  1.4 \\
                       & 3.0   & 10.0 &  0.6  &  2.0 \\
                       & 10.0  & --   &  --   &  --  \\
                       & 20.0  & --   &  --   &  --  \\
                       & 40.0  & --   &  --   &  --  \\ \hline

\multirow{5}{*}{LONGS} & 60.0  & 25.0 & 1.0   &  0.5 \\  
                       & 90.0  & 45.0 & 1.2   &  1.0 \\  
                       & 110.0 & 50.0 & --    &  1.4 \\  
                       & 135.0 & --   & --    &  2.0 \\  
                       & 150.0 & --   & --    &  --  \\  \hline \hline    
	 	\end{tabular}
	\end{table}


After obtaining the LUT from Ecolight, the spectral curves in the LUT are spectrally sampled to the OLI's spectral response. An example of a LUT created in Ecolight is shown in \autoref{fig:LUT} with 2000 spectral curves. 

\begin{figure}[htb]
    \centering
      \includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/ConferencesAndApplications/2014_ASPRS_SOY/Images/LUT.eps}
      \caption{LUT created in Hydrolight}
      \label{fig:LUT}
\end{figure}

% -----------------------------------------
\subsection{Retrieval}
The retrieval is divided in two stages (\autoref{fig:detailflowchart}). The first one uses the \acrfull{rmse} to fix the IOP set (ponds or lake) and the phase function. The \gls{rmse} is calculated between the water pixel and each element in the LUT, and the one with the smallest \gls{rmse} is selected as the first candidate. The IOP set and the phase function associated with this candidate is chosen as the IOP set and the phase function for the water pixel.

The second stage of the retrieval uses a non-linear optimization to estimate the CPA concentrations of the water pixel. Only the elements in the LUT with the same IOP set and phase function selected from the first stage are utilized in this stage. The water pixel is input to a non-linear optimization routine to estimate the CPA concentration through a trilinear interpolation within the LUT's elements. This method gives continuous concentration values. The \gls{rmse} and the non-linear optimization are described below.
% -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  
\subsubsection{Root Mean Square Error}
In this work, the RMSE is defined as
\begin{equation}
  RMSE(i) = \sqrt{\frac{1}{m}\sum_1^m\left[\widetilde{R}_{rs}(i,\lambda_m)-R_{rs}(\lambda_m)\right]^2}
\end{equation}
where $\widetilde{R}_{rs}(i,\lambda_m)$ is the $i$th database spectrum from the LUT at wavelength band $m$ and $R_{rs}(\lambda_m)$ is the spectrum for a particular water pixel from the image.

% -----------------------------------------
\subsubsection{Non-linear Optimization}
The spectral matching is made by a least square error minimization algorithm using the ``\texttt{lsqnonlin}'' package of the MATLAB's Optimization Toolbox. \texttt{lsqnonlin} solves least-squares problems, including nonlinear data-fitting problems \citep{MatlabHelp}. If $f(x)$ is a user-defined vector function defined as
\begin{equation}
  f(x)=
  \left[
    \begin{array}{c}
      f_1(x) \\
      f_2(x) \\
      \vdots \\
      f_m(x) \\
    \end{array}
  \right],
\end{equation}
with $x$ a vector. \texttt{lsqnonlin} tries to minimize the function
\begin{equation}
  \underset{x}{min}\parallel f(x) \parallel^2_2=\underset{x}{min}(f_1(x)^2+f_2(x)^2+f_3(x)^2+...+f_m(x)^2)
\end{equation}
In this case, $x$ includes the three CPA concentrations and the function $f(x)$ is the difference between the water spectra $R_{rs}$ for each pixel and an estimated curve $F$ from the LUT, this is
\begin{equation}
  f = R_{rs} - F
\end{equation}
where $F$ is obtained from a trilinear interpolation based on the CPA concentrations of the LUT. The dimension $m$ is the number of bands. In other words, for each pixel in the image, \texttt{lsqnonlin} tries to find a function that minimizes the error between the measured value and an interpolated spectra from the LUT. \texttt{lsqnonlin} stops the search after reaching a certain threshold. 

The output of this process is a concentration mapping for each water constituent that spans the range of constituents levels in the scene. 


% @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
\section{Validation} 
\label{sec:val}

The validation of the retrieval is performed through comparison with both {\it in situ} data and standard bio-optical products. This comparison is done for the results from the atmospheric correction (\gls{rrs}) and from the retrieval process (CPA concentrations). The following section will describe the area of study, the comparison with {\it in situ} data and the comparison with standard products.
% -------------------------------------------------------------
\subsection{Area of Study}
\label{subsec:areaofstudy}
The area of study for this research is the Lake Ontario Rochester Embayment (latitude: 4315'32.53"N and longitude: 7736'13.10"W), which includes some nearby ponds (Long and Cranberry Ponds), the Genesee River plume, the Irondequoit Bay and the southern end of Lake Ontario, as shown in Figure~\ref{fig:areaofstudy1} and Figure~\ref{fig:areaofstudy2}. This area was selected because it exhibits a wide range of variability in concentration of water constituents, including some eutrophic water bodies (ponds) with high concentration of CPAs, and oligomesotrophic water bodies (Lake Ontario) with low concentration of CPAs, so the retrieval algorithm can be tested with different scenarios. Landsat 8 images from this area of study and corresponding water samples collected at the time of the satellite's overpass will be used to test the retrieval algorithm. So far, there are only three satisfactory images available from the 2013, 2014 and 2015 seasons. Therefore, these images will be used to test the methodology. Note that a difficult challenge of this research is to obtain images with relatively clear weather conditions (i.e. cloud free) over the area of study when {\it in situ} data are also available.
\begin{figure}[htb]
  \centering
  \includegraphics[height=9cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/AreaOfStudy1.pdf}
  \caption{Location of the area of study. The chosen area of study is located in Rochester, NY, USA. \label{fig:areaofstudy1} } 
\end{figure}
\begin{figure}[htb]
  \centering
  \includegraphics[height=7cm]{/Users/javier/Desktop/Javier/PHD_RIT/Latex/Proposal/Images/AreaOfStudy2.pdf}
  \caption{Rochester Embayment. This area of study exhibit a variety of water types, from oligotrophic to eutrophic waters. \label{fig:areaofstudy2} } 
\end{figure}
\todo{check site labels in color printing!}

% -------------------------------------------------------------
\subsection{Comparison with {\it in situ} data}
A field collection that includes water samples and \gls{rrs} measurements was conducted at the same time as the sensor overpass. The $R_{rs}$ measurements were performed using either the spectroradiometers SVC HR-1024i  \citep{SVCHR1024i} or ASD FieldSpec 4 \citep{ASDManual2012} following the method described by \citet{Mobley:1999} for measuring \gls{rrs} from three consecutive measurements: the spectra of the downwelling irradiance $E_d$, the surface reflected sky radiance $L_s$, and the water-leaving radiance $L_w$ for each site (see Appendix~\ref{ch:fieldmea} for more details about the water samples collection and the $R_{rs}$ measurements). Then, the water samples were analyzed in the lab, following SeaWiFS protocols described in \citet{Mueller1995} for obtaining chlorophyll-{\it a} concentration ($C_a$) and total suspended solid concentration (TSS) (see Appendix~\ref{ch:labmea} for more details about the lab measurements). \autoref{tab:Sites} shows the different site names, location and the $C_a$ and $TSS$ for each site for the collection on 09-19-2013, as example. Note the difference in concentration levels between the ponds (i.e. LONGN, LONGS and CRANB) and the lake (i.e. ONTNS, ONTOS and ONTEX) samples.

% Site  & $C_a$  &    Latitude  & Longitude
% ONTNS &   ~~0.48 &  43.272159 & -77.538274  
% ONTOS &   ~~0.96 &  43.308923 & -77.540085  
% ONTEX &   ~~1.68 &  43.244892 & -77.536671  
% RVRPI &   ~~2.88 &  43.259925 & -77.601587  
% RVRPL &   ~~0.48 &  43.270990 & -77.592282  
% LONGN &   123.85 &  43.290836 & -77.690662  
% LONGS &   112.76 &  43.289182 & -77.696458  
% CRANB &   ~64.08 &  43.299938 & -77.692915  
% BRADI &   ~19.22 &  43.313675 & -77.717531  
% BRADO &   ~~1.44 &  43.325780 & -77.706432 

\begin{table}[!ht]
\caption{ Different sites for the collection on 09-19-2013. This collection included sampling in the ponds and the lake, which exhibit a wide range of concentrations. \label{tab:Sites} } 
\vspace{0.2cm}
\centering
\begin{tabular}{lccccl} 
 % \bfseries{Band n} & \bfseries{$m$}      & \bfseries{$y_0$}    & \bfseries{$R^2$}     & \bfseries{$RMSE$} & $y(x=45^\circ)$   \\ \hline \hline
 \hline
Site  &     Latitude  & Longitude  &  $C_a$      &  $TSS$   & Description \\ 
      &               &        &  $[mg/m^3]$ & $[g/m^3]$  &   \\ \hline \hline
ONTNS &     43.272159 & -77.538274 &  ~~0.48 & ~1.60      & Lake Ontario near-shore \\    
ONTOS &     43.308923 & -77.540085 &  ~~0.96 & ~1.00      & Lake Ontario off-shore  \\    
ONTEX &     43.244892 & -77.536671 &  ~~1.68 & ~0.70      & Lake Ontario extra  \\    
RVRPI &     43.259925 & -77.601587 &  ~~2.88 & ~2.10      & Genese River pier \\    
RVRPL &     43.270990 & -77.592282 &  ~~0.48 & ~1.00      & Genese River plume  \\    
LONGN &     43.290836 & -77.690662 &  123.85 & 48.00      & Long Pond north \\    
LONGS &     43.289182 & -77.696458 &  112.76 & 46.00      & Long Pond south \\    
CRANB &     43.299938 & -77.692915 &  ~64.08 & 26.70      & Cranberry Pond  \\    
BRADIN&     43.313675 & -77.717531 &  ~19.22 & 13.10      & inside Braddock bay \\    
BRADONT&  43.325780 & -77.706432 &  ~~1.44 & ~2.00        & Braddock Bay, Lake Ontario side \\  \hline
 \end{tabular}  
\end{table} 

\begin{figure}[htbp!]
  \centering
  \includegraphics[height=8.0cm]{/Users/javier/Desktop/Javier/PHD_RIT/ConferencesAndApplications/2015_SPIE_SanDiego/Images/ROI_RocEmbayment130919-eps-converted-to.pdf}
  \caption{Landsat 8 image acquired on 09-19-2013 (scene LC80160302013262LGN00) showing the study area, the Rochester Embayment. The labels indicate the sites of the field collection at the same time as the satellite overpass (\autoref{tab:Sites}).\label{fig:RrsROIs130919} } 
\end{figure}

Additionally, in order to have outputs in Hydrolight that are representative of the water bodies that are being studied, inherent optical properties (IOPs) of those specific waters have to be defined as input to the Hydrolight/Ecolight model. After collection, these water samples are analyzed in the lab to obtain IOPs for the main water constituents (see Appendix~\ref{ch:labmea} for more info about these lab measurements). Some IOPs and concentration measurements are used for the MoB-ELM algorithm and for the LUT creation described previously (\S\ref{subsec:mobelm} and \S\ref{subsec:LUTgen}, respectively). 

The measured \gls{rrs}s and CPA concentrations are used to validate the developed MoB-ELM and retrieval algorithms by comparison (\autoref{fig:detailflowchart})). The \acrfull{rmse} and \acrfull{nrmse} are utilized to quantify these comparisons.

% Furthermore, apparent optical properties (AOPs) (i.e. water-leaving reflectance) and backscattering measurements will be also collected for further comparison and to pursue closure between the Hydrolight AOPs results and in-situ AOPs measurements.

% ----------------------------------------------------
\subsection{Comparison with standard bio-optical product}
The \gls{rrs} spectra obtained from the \gls{mobelm} method are compared with the results from the \citet{Gordon:1994} approach obtained from both the ``l2gen'' tool in \gls{seadas} (\S\ref{subsec:seadasrrs}) and \gls{acolite} (\S\ref{subsec:acolite}), along with {\it in situ} data.

Additionally, this study presents a comparison of chlorophyll-{\it a} concentrations ($C_a$) retrieved from the standard bio-optical products described in \S\ref{subsec:chlempirical} (using \gls{seadas}) with the $C_a$ retrieved from the developed retrieval algorithm. These results are further compared with {\it in situ} data.

% The results from the retrieval process will be validated by comparison with the concentration of water samples taken during field campaigns in the spring and summer of 2013 and 2014\todo{2015?}. These concentrations will be obtained from lab measurements made at the Rochester Institute of Technology. %For further validation, the results will be compared with products derived from ocean color satellites such as MODIS (e.g. MODIS Chl-{\it a} product), in regions where it is possible.

% ----------------------------------------------------
\section{Concluding Remarks}
The purpose of this chapter was to introduce the methodology required to achieve the objectives defined in Chapter \ref{ch:objectives}. First, we began by explaining the different atmospheric correction techniques that will be investigated in this research along with the solar-glint removal algorithm. These atmospheric correction techniques include two different approaches. The first approach includes methods applied to ocean color satellites. The second one is the MoB-ELM method. The in-water constituent retrieval process was presented. The LUT generation and the metrics used to perform the retrieval were described. Additionally, the ground truth data collection was briefly explained. Finally, how the results will be validated was described. 

The next Chapter (\S\ref{ch:results}) will present the data and laboratory measurements available to date, along with the final results. These results include the \gls{mobelm} atmospheric correction applied to Landsat 8 imagery, and concentration of CPA maps obtained from the developed retrieval.
